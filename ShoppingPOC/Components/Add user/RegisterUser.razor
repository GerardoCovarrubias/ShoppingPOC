@page "/RegisterUser"
@rendermode InteractiveServer
@using BusinessLogic.Contracts
@using Models
@using System.Text.RegularExpressions
@implements IDisposable

<EditForm EditContext="@_editContext" OnValidSubmit="NewUser">
    <DataAnnotationsValidator />

    <h3>Register User</h3>

    <div class="grid-container">

        <div class="form-group">
            <label for="firstName">First Name</label>
            <InputText id="firstName" class="form-control" @bind-Value="_user.FirstName" />
        </div>

        <div class="form-group">
            <label for="lastName">Last Name</label>
            <InputText id="lastName" class="form-control" @bind-Value="_user.LastName" />
        </div>
        
        <div class="form-group">
            <label for="email">Email</label>
            <InputText id="email" class="form-control" @bind-Value="_user.Email" />
            <ValidationMessage For="@(() => _user.Email)" />
        </div>

        <div class="form-group">
            <label for="telephone">Telephone</label>
            <InputText type="tel" id="telephone" class="form-control" @bind-Value="_user.Telephone" />
            <ValidationMessage For="@(() => _user.Telephone)" />
        </div>

        <div class="form-group mt-3 position-relative">
            <label for="password">Password</label>
            <InputText id="password" type="password" class="form-control" @bind-Value="_user.Password" />
            <span class="password-toggle" onclick="togglePasswordVisibility()">
            </span>
            <ValidationMessage For="@(() => _user.Password)" />
        </div>

        <div class="form-group mt-3 position-relative">
            <label for="confirmPassword">Confirm Password</label>
            <InputText id="confirmPassword" type="password" class="form-control" @bind-Value="_PasswordConfirmation" />
            <span class="password-toggle" onclick="togglePasswordVisibility()">
            </span>
            <ValidationMessage For="@(() => _PasswordConfirmation)" />
        </div>
       
        <div class="form-group mt-3">
            <button type="submit" class="btn btn-primary btn-login">Register user</button>
        </div>
        @if (!string.IsNullOrEmpty(_emailStatusMessage))
        {
            <div class="alert alert-info mt-3">@_emailStatusMessage</div>
        }
    </div>
</EditForm>

@if (_spinner)
{
    <Spinner Label="Sending code..." />

}
@code {
    [Inject]
    private ILoginService _loginService { get; set; }
    [Inject]
    private NavigationManager _navManager { get; set; }

    private User _user { get; set; } = new();
    private EditContext _editContext;
    private ValidationMessageStore _messageStore;
    private string _PasswordConfirmation { get; set; } = string.Empty;
    private string _emailStatusMessage;
    private string _telephoneInput { get; set; } = string.Empty;
    private bool _spinner { get; set; } = false;

    protected override void OnInitialized()
    {
        _editContext = new EditContext(_user);
        _messageStore = new ValidationMessageStore(_editContext);
    }

    private async Task NewUser()
    {
        // Clear previous custom validation messages
        _messageStore.Clear();
        _editContext.NotifyValidationStateChanged();

        // 1) Sanitize telephone: remove all non-digits
        var digitsOnly = Regex.Replace(_user.Telephone ?? string.Empty, @"\D", string.Empty);

        if (string.IsNullOrWhiteSpace(digitsOnly))
        {
            var fieldId = new FieldIdentifier(this, nameof(_user.Telephone));
            _messageStore.Add(fieldId, "Telephone is required and must contain digits.");
            _editContext.NotifyValidationStateChanged();
            return;
        }
        

        // 3) Password confirmation check
        if (_user.Password != _PasswordConfirmation)
        {
            var fieldId = new FieldIdentifier(this, nameof(_PasswordConfirmation));
            _messageStore.Add(fieldId, "Passwords do not match.");
            _editContext.NotifyValidationStateChanged();
            return;
        }

        _user.Telephone = digitsOnly;

        // Proceed with registration
        Console.WriteLine($"Registering User: {_user.FirstName} {_user.LastName}, Email: {_user.Email}, Telephone: {_user.Telephone}");

        // Call the service
        await _loginService.RegisterUserAsync(_user);
        
        _spinner = true;
        _emailStatusMessage = "The mail was sent successfully.";
        StateHasChanged();
        await Task.Delay(2000);
        _navManager.NavigateTo("/Login");
    }

    public void Dispose()
    {
        _messageStore?.Clear();
    }
}
