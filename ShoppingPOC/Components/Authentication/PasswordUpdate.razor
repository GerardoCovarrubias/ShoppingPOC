@using System.ComponentModel.DataAnnotations  
@rendermode InteractiveServer  
@using BusinessLogic.Contracts
<Component />@using BusinessLogic.Services
@using Models
@using ShoppingPOC.ViewModels


@if (IsVisible)
{
    <h3>Pasword Update</h3>
    <EditForm Model=@_passwordUpdateVM OnValidSubmit="HandlePasswordChange" FormName="formCambiarPassword">
        <DataAnnotationsValidator />
        <div class="grid-container">

            <div class="form-group">
                <label for="newPassword">New Password</label>
                <InputText id="newPassword" type="password" class="form-control"
                           @bind-Value="_passwordUpdateVM.NewPassword" />
                <ValidationMessage For="@(() => _passwordUpdateVM.NewPassword)" />
            </div>

            <div class="form-group">
                <label for="confirPassword">Confirm Password</label>
                <InputText id="confirPassword" type="password" class="form-control"
                           @bind-Value="_passwordUpdateVM.PasswordConfirmation" />
                <ValidationMessage For="@(() => _passwordUpdateVM.PasswordConfirmation)" />
            </div>
            <div class="form-group mt-3">
                <button type="submit" class="btn btn-primary">Save new password</button>
            </div>
        </div>
    </EditForm>



}

@if (_spinner)
{
    <Spinner Label="Charging Login Page..." />
}

@code {
    [Parameter]
    public bool IsVisible { get; set; } = true;

    [Parameter]
    public string EmailValidation { get; set; }

    [Inject]  
    private ILoginService _loginService { get; set; }  

    [Inject]
    private NavigationManager _navManager { get; set; }

    [SupplyParameterFromForm(FormName = "formCambiarPassword")]  

    private PasswordUpdateViewModel _passwordUpdateVM { get; set; } = new();
    private bool _spinner = false;

    private async Task HandlePasswordChange()  
    {    
        Console.WriteLine("Email: " + EmailValidation);
        await _loginService.ChangePasswordAsync(EmailValidation, _passwordUpdateVM.NewPassword);
        Console.WriteLine("Valid password: " + _passwordUpdateVM.NewPassword);
        StateHasChanged();
        await Task.Delay(1000);
        _spinner = true;
        StateHasChanged();
        await Task.Delay(2000);
        
        _navManager.NavigateTo("/Login");
    }  
}
