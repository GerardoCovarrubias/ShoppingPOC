@page "/PasswordUpdate"  
@using System.ComponentModel.DataAnnotations  
@rendermode InteractiveServer  
@using BusinessLogic.Contracts  
@using BusinessLogic.Services
@using Models
@using ShoppingPOC.ViewModels


<h3>Pasword Update</h3>  
<EditForm model=@_user OnValidSubmit="HandlePasswordChange" FormName="formCambiarPassword">  

    <div class="grid-container">  
        <div class="form-group">  
            <label for="newPassword">New Password</label>  
            <InputText id="newPassword" type="password" class="form-control" @bind-Value="_newPassword" /> 
        </div>  

        <div class="form-group">  
            <label for="confirPassword">Confirm Password</label>  
            <InputText id="confirPassword" type="password" class="form-control" @bind-Value="_user.Password" />
        </div>
        @if (_showMismatchMessage && _newPassword != _user.Password)
        {
            <div class="text-danger">Passwords do not match</div>
        }
        <div class="form-group mt-3">  
            <button type="submit" class="btn btn-primary">Save new password</button>  
        </div> 
    </div>
    
</EditForm>  

@code {  
    [Inject]  
    private ILoginService _loginService { get; set; }  

    [Inject]
    private NavigationManager _navManager { get; set; }
    
    [SupplyParameterFromForm(FormName = "formCambiarPassword")]  

    private User _user { get; set; } = new();
    private PasswordResetViewModel _resetState { get; set; } = new();
    private string _newPassword { get; set; } = string.Empty;
    private bool _showMismatchMessage = false;

    private async Task HandlePasswordChange()  
    {  
        if (_newPassword != _user.Password)
         {  
            _showMismatchMessage = true;  
            return;  
         }  
         
        await _loginService.ChangePasswordAsync(_resetState.Email, _user.Password);
        Console.WriteLine("Valid password: " + _user.Password);  
        _navManager.NavigateTo("/Login");
    }  
}
